<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador de Autoescuelas - Entrega Final</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.0/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.0/MarkerCluster.Default.css" />
    <style>
        * {margin: 0; padding: 0; box-sizing: border-box;}
        body {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; overflow: hidden;}
        .app-wrapper {display: flex; height: 100vh; width: 100%; flex-direction: column;}
        .header {background: linear-gradient(to right, #2c3e50 0%, #17a2b8 100%); color: white; padding: 16px 20px; flex-shrink: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
        .header h1 {font-size: 22px; font-weight: 600; margin: 0;}
        .header p {font-size: 12px; opacity: 0.9; margin: 4px 0 0 0;}
        .main-container {display: flex; flex: 1; gap: 0; overflow: hidden;}
        .left-panel {width: 300px; background: white; border-right: 1px solid #ddd; overflow-y: auto; padding: 20px; flex-shrink: 0;}
        .left-panel h2 {font-size: 16px; color: #2c3e50; margin-bottom: 16px; padding-bottom: 10px; border-bottom: 2px solid #17a2b8;}
        .form-group {margin-bottom: 14px;}
        .form-group label {display: block; font-size: 11px; font-weight: 600; text-transform: uppercase; color: #2c3e50; margin-bottom: 6px; letter-spacing: 0.5px;}
        .form-group select, .form-group input {width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; font-family: inherit; background: white;}
        .form-group select:focus, .form-group input:focus {outline: none; border-color: #17a2b8; box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.1);}
        .button-group {display: flex; gap: 8px; margin: 16px 0;}
        .btn-search {flex: 1; background: #17a2b8; color: white; padding: 12px 16px; border: none; border-radius: 4px; font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.2s; text-transform: uppercase;}
        .btn-search:hover {background: #138496;}
        .btn-clear {flex: 1; background: #95a5a6; color: white; padding: 12px 16px; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer; transition: background 0.2s; text-transform: uppercase;}
        .btn-clear:hover {background: #7f8c8d;}
        .result-info {background: #ecf0f1; padding: 12px; border-radius: 4px; font-size: 13px; font-weight: 600; color: #2c3e50; text-align: center; margin: 12px 0;}
        .status-box {background: #d4edda; border: 1px solid #28a745; padding: 12px; border-radius: 4px; font-size: 12px; color: #155724; margin-bottom: 12px; font-weight: 600;}
        .center-map {flex: 1; background: #e0e0e0; position: relative; overflow: hidden;}
        #map {width: 100%; height: 100%;}
        .right-panel {width: 280px; background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; overflow: hidden; flex-shrink: 0;}
        .results-header {background: #2c3e50; color: white; padding: 16px; font-size: 16px; font-weight: 600; border-bottom: 1px solid #1c2833; flex-shrink: 0;}
        .results-count {font-size: 12px; font-weight: 400; color: #ecf0f1; margin-top: 4px;}
        .results-container {flex: 1; overflow-y: auto; padding: 10px;}
        .result-card {background: white; border: 1px solid #ecf0f1; border-radius: 6px; padding: 14px; margin-bottom: 10px; cursor: pointer; transition: all 0.15s;}
        .result-card:hover {box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-color: #17a2b8;}
        .result-title {font-weight: 600; font-size: 13px; color: #2c3e50; margin-bottom: 6px;}
        .result-address {font-size: 12px; color: #7f8c8d; margin-bottom: 3px;}
        .result-location {font-size: 11px; color: #95a5a6; margin-bottom: 8px;}
        .result-phone {font-size: 13px; color: #e74c3c; font-weight: 600; text-decoration: none;}
        .empty-results {text-align: center; padding: 30px 15px; color: #95a5a6; font-size: 12px;}
        .instructions {background: #fef9e7; border-left: 4px solid #f39c12; padding: 12px; border-radius: 4px; font-size: 11px; color: #7d6608; line-height: 1.6; margin-top: 12px;}
        ::-webkit-scrollbar {width: 8px;}
        ::-webkit-scrollbar-thumb {background: #bdc3c7; border-radius: 4px;}
    </style>
</head>
<body>
    <div class="app-wrapper">
        <div class="header">
            <h1>üöó Buscador de Autoescuelas Espa√±a</h1>
            <p>Datos validados 100% - Geocodificaci√≥n corregida</p>
        </div>
        <div class="main-container">
            <div class="left-panel">
                <h2>üîç B√∫squeda</h2>
                <div class="status-box">‚úì Datos 100% validados y corregidos</div>
                <div class="form-group">
                    <label>Comunidad Aut√≥noma</label>
                    <select id="selectComunidad">
                        <option value="">-- Selecciona comunidad --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Provincia</label>
                    <select id="selectProvincia">
                        <option value="">-- Todas las provincias --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Buscar por nombre o ciudad</label>
                    <input type="text" id="inputNombre" placeholder="Ej: Academia, Valencia...">
                </div>
                <div class="button-group">
                    <button class="btn-search" id="btnBuscar">üîç Buscar</button>
                    <button class="btn-clear" id="btnLimpiar">‚Ü∫ Limpiar</button>
                </div>
                <div class="result-info" id="resultInfo">Realiza una b√∫squeda</div>
                <div class="instructions">
                    <strong>üí° Pasos:</strong>
                    1. Selecciona comunidad<br>
                    2. (Opt) Provincia<br>
                    3. (Opt) Nombre<br>
                    4. Busca
                </div>
            </div>
            <div class="center-map">
                <div id="map"></div>
            </div>
            <div class="right-panel">
                <div class="results-header">
                    Resultados
                    <div class="results-count" id="resultsCount">-</div>
                </div>
                <div class="results-container" id="resultsContainer">
                    <div class="empty-results">Realiza una b√∫squeda para ver resultados</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.0/leaflet.markercluster.js"></script>
    <script>
        let map, allData = [], filteredData = [], markerGroup, markerMap = new Map();

        document.addEventListener('DOMContentLoaded', async () => {
            initMap();
            await loadData();
            initCommunities();
            attachEvents();
        });

        function initMap() {
            map = L.map('map').setView([40.4637, -3.7492], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap', maxZoom: 19
            }).addTo(map);
            markerGroup = L.markerClusterGroup({ maxClusterRadius: 80 });
            map.addLayer(markerGroup);
        }

        async function loadData() {
            try {
                const response = await fetch('autoescuelas_final_100porciento.json');
                allData = await response.json();
                console.log(`‚úì ${allData.length} autoescuelas cargadas y verificadas`);
            } catch (e) {
                console.error('Error:', e);
            }
        }

        function initCommunities() {
            const select = document.getElementById('selectComunidad');
            const coms = [...new Set(allData.map(a => a.comunidad_autonoma || '').filter(c => c))].sort();
            coms.forEach(com => {
                const opt = document.createElement('option');
                opt.value = com;
                opt.textContent = com;
                select.appendChild(opt);
            });
        }

        function attachEvents() {
            document.getElementById('selectComunidad').addEventListener('change', updateProvinces);
            document.getElementById('btnBuscar').addEventListener('click', search);
            document.getElementById('btnLimpiar').addEventListener('click', clear);
            document.getElementById('inputNombre').addEventListener('keypress', e => e.key === 'Enter' && search());
        }

        function updateProvinces() {
            const com = document.getElementById('selectComunidad').value;
            const prov = document.getElementById('selectProvincia');
            prov.innerHTML = '<option value="">-- Todas las provincias --</option>';
            if (!com) return;
            const provs = [...new Set(allData.filter(a => a.comunidad_autonoma === com).map(a => a.provincia || ''))].filter(p => p).sort();
            provs.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.textContent = p;
                prov.appendChild(opt);
            });
        }

        function search() {
            const com = document.getElementById('selectComunidad').value;
            const prov = document.getElementById('selectProvincia').value;
            const nombre = document.getElementById('inputNombre').value.toLowerCase();
            filteredData = allData.filter(item => {
                if (com && item.comunidad_autonoma !== com) return false;
                if (prov && item.provincia !== prov) return false;
                if (nombre && !item.nombre.toLowerCase().includes(nombre) && !item.poblacion.toLowerCase().includes(nombre)) return false;
                if (!item.lat || !item.lng) return false;
                return true;
            });
            updateMap();
            updateResults();
        }

        function updateMap() {
            markerGroup.clearLayers();
            markerMap.clear();
            filteredData.forEach(item => {
                if (item.lat && item.lng) {
                    const marker = L.marker([item.lat, item.lng]);
                    const id = `${item.nombre}|${item.domicilio}|${item.codigo_postal}`;
                    const html = `<div style="font-size:12px;line-height:1.5;"><h3 style="margin:0 0 8px 0;font-size:13px;color:#2c3e50;">${item.nombre}</h3><p style="margin:0;color:#555;font-size:11px;"><strong>Direcci√≥n:</strong> ${item.domicilio}</p><p style="margin:0;color:#555;font-size:11px;"><strong>Poblaci√≥n:</strong> ${item.poblacion} (${item.codigo_postal})</p><p style="margin:0;color:#555;font-size:11px;"><strong>Comunidad:</strong> ${item.comunidad_autonoma}</p>${item.telefono ? `<p style="margin:4px 0 0 0;"><a href="tel:${item.telefono}" style="color:#e74c3c;text-decoration:none;font-weight:600;">${item.telefono}</a></p>` : ''}</div>`;
                    marker.bindPopup(html);
                    marker.id = id;
                    markerGroup.addLayer(marker);
                    markerMap.set(id, marker);
                }
            });
            document.getElementById('resultInfo').textContent = `${filteredData.length} autoescuelas encontradas`;
            document.getElementById('resultsCount').textContent = `${filteredData.length}`;
        }

        function updateResults() {
            const container = document.getElementById('resultsContainer');
            if (filteredData.length === 0) {
                container.innerHTML = '<div class="empty-results">No hay resultados</div>';
                return;
            }
            container.innerHTML = filteredData.map(item => `
                <div class="result-card" onclick="goToMarker('${item.nombre}|${item.domicilio}|${item.codigo_postal}')">
                    <div class="result-title">${item.nombre}</div>
                    <div class="result-address">${item.domicilio}</div>
                    <div class="result-location">${item.codigo_postal} ${item.poblacion}, ${item.provincia}</div>
                    ${item.telefono ? `<a href="tel:${item.telefono}" class="result-phone">${item.telefono}</a>` : ''}
                </div>
            `).join('');
        }

        function goToMarker(id) {
            const marker = markerMap.get(id);
            if (marker) {
                map.setView(marker.getLatLng(), 15);
                marker.openPopup();
            }
        }

        function clear() {
            document.getElementById('selectComunidad').value = '';
            document.getElementById('selectProvincia').value = '';
            document.getElementById('inputNombre').value = '';
            document.getElementById('resultInfo').textContent = 'Realiza una b√∫squeda';
            document.getElementById('resultsCount').textContent = '-';
            document.getElementById('resultsContainer').innerHTML = '<div class="empty-results">Realiza una b√∫squeda para ver resultados</div>';
            markerGroup.clearLayers();
        }
    </script>
</body>
</html>
